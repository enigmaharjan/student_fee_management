<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Student Fee Management System</title>
</head>

<body>
    <div>
        <div>
            <select id="select"></select>
        </div>
        <div>
            <button id="search">Search</button>
        </div>
        <div>
            <select id="select_student" required aria-placeholder="Click Search Button First"></select>
        </div>
    </div>

    <script>
        window.onload = function () {
            const url = "http://localhost:3000/"

            fetch(url + 'api/batch', {
                headers: {
                    "authorization": localStorage.getItem('Token')
                }
            })
                .then(data => {
                    return data.json()
                })
                .then(json => {
                    if (json.name === "JsonWebTokenError") {
                        alert("You are not authorized.\nPlease Login First")
          window.location.href = 'index.html';
        }
                    const list = document.getElementById('list');
                    const select = document.getElementById('select');
                    for (let i = 0; i < json.length; i++) {
                        const option = document.createElement('OPTION'),
                            txt = document.createTextNode(json[i].batch_name);
                        option.appendChild(txt);
                        option.setAttribute("value", json[i]);
                        select.insertBefore(option, select.lastChild);
                    }
                });

            async function onClick(event) {
                const val = select.selectedIndex;
                const batch = select.options[val].innerText;

                let btnz = document.createElement("div");
                        // let txt = "";
                        let text = "";
                        let  student_name = " ";
                // console.log(url + 'api/fee/' + batch +'/1')
                 fetch(url + 'api/fee/' + batch + '/0')
                    .then(data => {
                        return data.json()
                    })
                    .then(json => {
                        // const select_student = document.getElementById('select_student');
                        // select_student.options.length = null;  //to clear the elements in drop down menu.
                        // for (let i = 0; i < json.length; i++) {
                        //     const option = document.createElement('OPTION'),
                        //         txt = document.createTextNode(json[i].student_id);
                        //     option.appendChild(txt);
                        //     option.setAttribute("value", json[i]);
                        //     select_student.insertBefore(option, select_student.firstChild);
                        // }
                        
                        for  (let x = 0; x < json.length; x++) {

                            text += "<div id = 'main'>";
                            const id = json[x].student_id;
                            let a = JSON.stringify(getStudent(id))
                            text += "<p id = 'source'>Student ID: " + "<a href='" + a + "'>" + json[x].student_id + "</a></p>";
   
                             fetch(url + 'api/students/' + id)
                                .then(data => {
                                    return data.json()
                                })
                                .then(json => {
                                    text += "<p id = 'source'>Name: " + json[0].student_name + "</p>";
                                    btnz.innerHTML = text;       //showing name in the page
                                    student_name = json[0].student_name ;
                                    // return {data : JSON.stringify(json[0])};
                                    // return {data : json[0]};
                                    // alert(JSON.stringify(json[0])); 
                                    return student_name;

                                })
                                .catch(err => {
                                    return err;
                                })
                                text += "<p id = 'source'>Name: " +  student_name + "a"+ "</p>";
                                // alert(JSON.stringify(a))
                                // text += JSON.stringify(a.student_name);?
                            text += "<h3 id = 'title'>Amount: " + json[x].amount + "</h3>";
                            text += "<button>Click</button>"
                            text += "</div>"
                        }
                        btnz.innerHTML = text;
                        document.body.appendChild(btnz);


                        //


                    })
                    .catch(error => {
                        console.log(error)
                        alert(error)
                    })
            }
            async function getStudent(student_id) {
                await fetch(url + 'api/students/' + student_id)
                    .then(data => {
                        return data.json()
                    })
                    .then(json => {
                        // console.log("text")
                                    // text += "<p id = 'source'>Name: " + JSON.stringify(json[0].student_name) + "</p>";
                                    // btnz.innerHTML = text;
                        //             // document.body.appendChild(btnz);
                        //             // return text;     //showing name in the page
                        // // return json;
                        // console.log(json[0].student_name)
                        // // texts = JSON.stringify(json[0].student_name);
                        // // return texts;
                        // alert(json[0].student_name)
                        const resp = json[0].student_name;
                        alert(resp)
                        return resp.json()
                        // // return (json[0].student_name)


                    })
                    .catch(err => {
                        return err;
                    })
            }


            const searchButton = document.getElementById('search');
            searchButton.addEventListener('click', onClick)

        }
    </script>
</body>

</html>